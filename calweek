#!/usr/bin/python3

import datetime
import shlex
import subprocess
import sys

def display_time_from_unix(unix):
    d = datetime.datetime.fromtimestamp(unix)
    display_date = d.strftime("%Y-%m-%d")
    display_time = d.strftime("%H:%M")
    return (display_date, display_time)

if len(sys.argv) >=2:
    tz = sys.argv[1]
else:
    tz = "UTC"

week = subprocess.check_output(shlex.split(
    "calcurse "
    "-r7 "
    "--format-apt='%s|%e|%m\n' "
)).decode()

current_date = ""
for l in week.split("\n"):
    l = l.strip()
    if l == "":
        continue
    if l.count("/") == 2:
        if l.endswith(":"):
            l = l[:-1]
        # Date. we'll show that in each event
        continue
        # (m, d, y) = l.split("/")
        # print("-".join(['20' + y, m.zfill(2), d.zfill(2)]))
    (start, end, title) = l.split("|", 2)
    (s_d, s_t) = display_time_from_unix(int(start))
    if s_d == current_date:
        s_d = " " * len("YYYY-MM-DD")
    (_, e_t) = display_time_from_unix(int(end))
    print(""
          "" + s_d + " " + s_t + ""
          " -> "
          "" + e_t + " "
          "" + title)
    current_date = s_d
